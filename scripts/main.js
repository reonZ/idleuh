(()=>{"use strict";let e="";function t(t){game.socket.emit(`module.${e}`,t)}const i="Compendium.pf2e.feats-srd.KlqKpeq5OmTRxVHb";function n(e){const t=["esoteric","esoteric-lore","lore-esoteric"],i=Object.values(e.skills).find((e=>t.includes(e.slug)));return i||ui.notifications.warn("This character doesn't have the 'Esoteric' skill"),i}function a(){return game.i18n.format("PF2E.SkillCheckWithName",{skillName:"Esoteric"})}function s(e){return e.itemTypes.feat.some((e=>e.getFlag("core","sourceId")===i))}function r(e,t){if(!t||!t.isOwner||!t.isOfType("character"))return void ui.notifications.warn("You must select a character token you own.");const i=n(t);if(!i)return;const r=new Set,o=a();let c=`<h4 class="action">${o}</h4><section class="roll-note">Can be used to Recall Knowledge regarding haunts, curses \nand creatures of any type, but can't be used to Recall Knowledge of other topics.</section>`;e.ctrlKey&&s(t)&&(r.add("diverse-lore"),c+='<section class="roll-note"><strong>Diverse Lore</strong> You can take a -2 penalty to your check to Recall \nKnowledge about any topic, not just the usual topics available for Esoteric Lore.</section>'),game.pf2e.Check.roll(new game.pf2e.CheckModifier(c,i),{actor:t,title:o,type:"skill-check",rollMode:"blindroll",options:r},e)}function o(e){return e.getFlag("core","sourceId")}function c(e){return Array.isArray(e)?t=>function(e,t){const i=o(e);return!!i&&t.includes(i)}(t,e):t=>o(t)===e}function l(e,t){return t?t.flatMap((t=>e.itemTypes[t])):e.items}function u(e,t,i){return l(e,i).find(c(t))}const d="Compendium.idleuh.effects.MqgbuaqGMJ92VRze",m="Compendium.idleuh.effects.Lz5hNf4dbXKjDWBa",f="Compendium.idleuh.effects.8BxBB5ztfRI9vFfZ",p="Compendium.pf2e.conditionitems.AJh5ex99aV6VTggg";async function h(e,i,r){if(e.ctrlKey)return game.user.isGM?y():t({type:"clean-exploit-vulnerability"}),void ui.notifications.notify("All effects are being removed.");const o=game.user.targets,[m]=o,f=m?.actor;if(!(i&&i.isOwner&&i.isOfType("character")&&1===o.size&&f&&f.isOfType("creature")))return void ui.notifications.warn("You must select a character token you own and target another one.");const h=n(i);if(!h)return;const b=f.system.details.level.value,w=b<0?13:[14,15,16,18,19,20,22,23,24,26,27,28,30,31,32,34,35,36,38,39,40,42,44,46,48,50][b],k=i.getRollOptions(["all","skill-check","Esoteric"]);k.push("action:recall-knowledge"),k.push("secret");const $=f.system.attributes.weaknesses,M=$.reduce(((e,t)=>t.value>e?t.value:e),0),C=$.filter((e=>e.value===M)).map((e=>e.type)),x=await game.pf2e.Check.roll(new game.pf2e.CheckModifier("test",h),{actor:i,target:{actor:f,token:m.document},title:a(),type:"skill-check",options:k,dc:{value:w},createMessage:!1},e),I=x.total??0,O=x.dice[0]?.total??0,j=v(I,O,w),F=u(i,d,["effect"]);if(j>=1&&!F){const e=(await fromUuid(d)).toObject();i.createEmbeddedDocuments("Item",[e])}else if(j<1){F?.delete();const e=function(e,t,i){return l(e,["condition"]).some(c(t))}(i,p);if(!e){const e=(await fromUuid(p)).toObject();i.createEmbeddedDocuments("Item",[e])}}!function(e,t,i,n,a,r,o,c){const l=n-i,u=n-a,d=r>=3?"criticalSuccess":2===r?"success":1===r?"failure":"criticalFailure",m=r>=3?"Critical Success":2===r?"Success":1===r?"Failure":"Critical Failure";let f=`<h4 class="action"><span class="pf2-icon">A</span> <b>Exploit Vulnerability</b> <p class="compact-text">(Esoteric Check)</p></h4>\n<div class="target-dc-result" data-visibility="gm">\n    <div class="target-dc" data-visibility="gm"><span data-visibility="gm" data-whose="target">\n        Target: ${t.name}</span> <span data-visibility="gm" data-whose="target">(Standard DC ${i})</span></div>\n    <div class="result degree-of-success" data-visibility="gm">\n        Result: <span title="Roll: ${a} ${u>=0?"+":"-"} ${Math.abs(u)}">${n}</span> \n        <span data-whose="self" class="${d}">${m}</span> <span data-whose="target">by ${l>=0?"+":""}${l}</span>\n    </div>\n</div>`;r>=2&&c.length&&(f+=`<div><strong>[ ${c.join(", ")} ]</strong> = ${o}</div>`),f+='<section class="roll-note">',f+=r>=3?"<strong>Critical Success</strong> You remember the creature's weaknesses, and as you empower your esoterica, \nyou have a flash of insight that grants even more knowledge about the creature. \nYou learn all of the creature's resistances, weaknesses, and immunities, \nincluding the amounts of the resistances and weaknesses and any unusual weaknesses or vulnerabilities, \nsuch as what spells will pass through a golem's antimagic. \nYou can exploit either the creature's mortal weakness or personal antithesis (see the Exploit Vulnerability class feature). \nYour unarmed and weapon Strikes against the creature also become magical if they weren't already.":2===r?"<strong>Success</strong> You recall an important fact about the creature, \nlearning its highest weakness (or one of its highest weaknesses, if it has multiple with the same value) but not its other weaknesses, \nresistances, or immunities. You can exploit either the creature's mortal weakness or personal antithesis. \nYour unarmed and weapon Strikes against the creature also become magical if they weren't already.":1===r?"<strong>Failure</strong> Failing to recall a salient weakness about the creature, \nyou instead attempt to exploit a more personal vulnerability. \nYou can exploit only the creature's personal antithesis. \nYour unarmed and weapon Strikes against the creature also become magical if they weren't already.":"<strong>Critical Failure</strong> You couldn't remember the right object to use and become distracted while you rummage \nthrough your esoterica. You become flat-footed until the beginning of your next turn.",f+="</section>",s(e)&&r>=2&&(f+=function(e,t,i){const n=(e.system.details.identification?.skill.progression??[]).map((e=>{const n=v(t,i,e);return`<span style="color: ${n>=3?"green":2===n?"blue":"#ff4500"};" title="${n>=3?"Critical Success":2===n?"Success":"Failure"}">${e}</span>`}));return`<section class="roll-note">\n    <strong>Diverse Lore</strong> Compare the result of your Esoteric Lore check to the DC${n.length?` <span data-visibility="gm">${n.join(", ")}</span>`:""} to Recall Knowledge for that creature; \n    if that number would be a success or a critical success, you gain information as if you had succeeded at the Recall Knowledge check.\n</section>`}(t,n,a)),ChatMessage.create({flavor:f,actor:e})}(i,f,w,I,O,j,M,C);const S=C.filter((e=>!r.includes(e))),D={type:"exploit-vulnerability",actorId:i.id,targetId:m.id,vulnerability:S.length?M:0,success:j};game.user.isGM?g(D):t(D)}async function g({actorId:e,targetId:t,vulnerability:i,success:n}){const a=game.actors.get(e),s=canvas.tokens.get(t)?.actor;if(!a||!s)return;const r=2+Math.floor(a.level/2),o=n>1&&i>=r,c=(await fromUuid(f)).toObject(),l={key:"Weakness",type:"piercing",value:i,predicate:["origin:effect:exploit-vulnerability"]};c.system.rules.push(l);for(const e of canvas.tokens.placeables){const t=e.actor;if(!t||t===a)continue;const l=u(t,m,["effect"]),d=u(t,f,["effect"]);if(await(l?.delete()),await(d?.delete()),!(n<1))if(t===s){const e=(await fromUuid(m)).toObject(),n={key:"Weakness",type:"piercing",value:o?i:r,predicate:["origin:effect:exploit-vulnerability"]};e.system.rules.push(n),t.createEmbeddedDocuments("Item",[e])}else o&&t.id===s.id&&t.createEmbeddedDocuments("Item",[c])}}function y(){for(const e of canvas.tokens.placeables){const t=e.actor;if(!t)continue;const i=u(t,d,["effect"]),n=u(t,m,["effect"]),a=u(t,f,["effect"]);i?.delete(),n?.delete(),a?.delete()}}function v(e,t,i){let n=e>=i+10?3:e>=i?2:e>i-10?1:0;return 20===t?n++:1===t&&n--,n}function b(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}const w=new Map;w.set(-1,13),w.set(0,14),w.set(1,15),w.set(2,16),w.set(3,18),w.set(4,19),w.set(5,20),w.set(6,22),w.set(7,23),w.set(8,24),w.set(9,26),w.set(10,27),w.set(11,28),w.set(12,30),w.set(13,31),w.set(14,32),w.set(15,34),w.set(16,35),w.set(17,36),w.set(18,38),w.set(19,39),w.set(20,40),w.set(21,42),w.set(22,44),w.set(23,46),w.set(24,48),w.set(25,50);const k=new Map;function M(e,t="common"){return function(e,t="normal"){return e+(k.get(t)??0)}(e,function(e="common"){return"uncommon"===e?"hard":"rare"===e?"very hard":"unique"===e?"incredibly hard":"normal"}(t))}k.set("incredibly easy",-10),k.set("very easy",-5),k.set("easy",-2),k.set("normal",0),k.set("hard",2),k.set("very hard",5),k.set("incredibly hard",10);const C=new Set(["arcane","divine","occult","primal"]),x=[];const I={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},O=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,j=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,F=(new RegExp(j,"gu"),String.raw`(?:${O})(?=${j})|(?:${j})(?=${O})`),S=String.raw`(?:${O})(?=${O})`,D=String.raw`\p{Lowercase_Letter}`,T=String.raw`\p{Uppercase_Letter}`;new RegExp(`(${D})(${T}${S})`,"gu"),new RegExp(`${T}|(?:${F})${D}`,"gu");const L={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"};Object.keys(L),Object.values(L);class R extends Application{items;constructor(e,t){super(t),this.items=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"idleuh-identify",title:"Identify Items",template:b("identify.html"),width:500})}getData(e){return mergeObject(super.getData(e),{items:this.items.map((e=>{const t=e.system.identification.identified,i=e.isIdentified,n=!i&&e.getFlag("world","identify.checked"),a=[];return i&&a.push("identified"),n&&a.push("checked"),{uuid:e.uuid,img:t.img,name:e.isOfType("treasure")?`($) ${t.name}`:t.name,css:a.join(" "),identified:i,checked:n}}))})}activateListeners(e){e.find('[data-action="chat"]').on("click",this.#e.bind(this)),e.find('[data-action="checks"]').on("click",this.#t.bind(this)),e.find('[data-action="identify"]').on("click",this.#i.bind(this)),e.find('[data-action="remove"]').on("click",this.#n.bind(this)),e.find('[data-action="reset"]').on("click",this.#a.bind(this))}async#e(e){(await Y(e))?.toMessage(void 0,{create:!0})}async#t(e){const t=await Y(e);if(!t)return;const i=t.system.identification.unidentified.img,n=t.system.identification.unidentified.name,a=t.system.identification.identified.name,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),r=function(e,{proficiencyWithoutLevel:t=!1,notMatchingTraditionModifier:i}){const n=function(e,{proficiencyWithoutLevel:t=!1,rarity:i="common"}={}){const n=w.get(e)??14;return M(t?n-Math.max(e,0):n,i)}(e.level,{proficiencyWithoutLevel:t}),a=function(e){return e.traits.has("cursed")?"unique":e.rarity}(e),s=M(n,a);return e.isMagical?function(e,t,i){const n={occult:t,primal:t,divine:t,arcane:t},a=function(e){const t=e.system.traits.value;return new Set(t.filter((e=>{return t=e,C.has(t);var t})))}(e);for(const e of C)a.size>0&&!a.has(e)&&(n[e]=t+i);return{arc:n.arcane,nat:n.primal,rel:n.divine,occ:n.occult}}(e,s,i):e.isAlchemical?{cra:s}:{dc:s}}(t,{proficiencyWithoutLevel:"ProficiencyWithoutLevel"===game.settings.get("pf2e","proficiencyVariant"),notMatchingTraditionModifier:s}),o=Object.entries(r).map((([e,t])=>({shortForm:e="dc"===e?"cra":e,dc:t,name:game.i18n.localize(L[e])}))),c=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:i,itemName:n,identifiedName:a,skills:o});await ChatMessage.create({user:game.user.id,content:c})}async#i(e){const t=await Y(e);t&&(await t.update({"system.identification.status":t.isIdentified?"unidentified":"identified","system.identification.unidentified":t.getMystifiedData("unidentified"),"flags.world.identify.checked":!1}),this.render())}async#n(e){const t=await Y(e);if(!t)return;const i=t.getFlag("world","identify.checked");await t.setFlag("world","identify.checked",!i),this.render()}async#a(e){e.preventDefault();for(const e of this.items)!e.isIdentified&&e.getFlag("world","identify.checked")&&await e.setFlag("world","identify.checked",!1);this.render()}}async function Y(e){const t=$(e.currentTarget).closest("[data-item]"),i=t.attr("data-item"),n=await fromUuid(i);return n||t.remove(),n}function E(){if(!game.user.isGM)return void ui.notifications.warn("You not the GM yo!");const e=game.actors.reduce(((e,t)=>{if(!t.hasPlayerOwner)return e;const i=t.items.filter((e=>e.isOfType("physical")&&!e.isIdentified));return e.push(...i),e}),[]);new R(e).render(!0)}const A="pf2e.spells-srd",N="Item.dcALVAyJbYSovzqt";async function U(e){if(!e)return ui.notifications.warn("You must select an actor with the Imaginarium");const t=e.itemTypes.equipment.find((e=>e.getFlag("core","sourceId")===N));if(!t||"dropped"===t.system.equipped.carryType)return ui.notifications.warn("This actor doesn't have the Imaginarium in their possession");const i=Math.floor(e.level/2),n=game.packs.get(A),a=(await n.getIndex({fields:["system.level.value","system.traits","system.category.value"]})).filter((e=>e.system.level.value<=i&&!e.system.traits.value.includes("cantrip")&&"ritual"!==e.system.category.value&&"focus"!==e.system.category.value&&"common"===e.system.traits.rarity)),s=a[Math.floor(Math.random()*a.length)],r=`Compendium.${A}.${s._id}`;let o=r,c="";const l=await async function(e,t,i=!1){const n=(await fromUuid(e))?.toObject();if(!n)return null;!1===t&&(t=n.system.level.value);const a=function(e){return`Compendium.pf2e.equipment-srd.${I[e]}`}(t);x[t]??=await fromUuid(a);const s=x[t]?.toObject();if(!s)return null;n.system.location.heightenedLevel=t,s.name=`Scroll of ${n.name} (Level ${t})`,s.system.temporary=i,s.system.spell=n,s.system.traits.value.push(...n.system.traditions.value);const r=n.flags.core?.sourceId;return r&&(s.system.description.value=`${function(e,t){return`@UUID[${e}]`}(r)}\n<hr />${s.system.description.value}`),s}(r,i);if(l){l.name=l.name+" *";const[t]=await e.createEmbeddedDocuments("Item",[l]);c=" and received the following:",o=t.uuid}ChatMessage.create({content:`<p>Ripped the last page of the Imaginarium${c}</p><p>@UUID[${o}]</p>`,speaker:ChatMessage.getSpeaker({actor:e})})}class V extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"idleuh-manual-token",template:b("manual-token.html"),title:"Manual Token Update",width:500})}activateListeners(e){super.activateListeners(e),e.find("button[type=button]").on("click",(()=>this.close()));const t=e.find("input[name=scale]"),i=t.next("span");t.on("input",(()=>{const e=t[0].valueAsNumber;i.text(e.toFixed(2))}));const n=e.find("input[name=grid]"),a=n.next("span");n.on("input",(()=>{const e=n[0].valueAsNumber;a.text(e.toFixed(1))}))}async _updateObject(e,t){const i=this.object,n={displayName:Number(t.name),displayBars:Number(t.hp),"texture.src":t.img,"flags.pf2e.linkToActorSize":!!t.link,width:Number(t.grid),height:Number(t.grid),"texture.scaleX":Number(t.scale),"texture.scaleY":Number(t.scale)},a={};for(const[e,t]of Object.entries(n))getProperty(i,e)!==t&&setProperty(a,e,t);Object.keys(a).length&&this.object.update(a)}}async function G(e){e&&e.isOwner?new V(e.document).render(!0):ui.notifications.warn("You need to select an owned token.")}const K=["trained","expert","master","legendary","untrained"];async function W(){if(!game.user.isGM)return void ui.notifications.warn("You not the GM yo!");let e="<hr>";const t=canvas.tokens;for(const i of t.placeables){const t=i.actor;t&&t.isOfType("character","npc")&&t.hasPlayerOwner&&t.attributes.perception&&(e+=await q(t))}ChatMessage.create({content:e,flavor:"Group Perception Checks",whisper:[game.user.id]})}async function q(e){const t=e.attributes.perception,i=new game.pf2e.CheckModifier("",t),n=await game.pf2e.Check.roll(i,{actor:e,type:"skill-check",createMessage:!1,skipDialog:!0});if(!n)return"";const a=K[(t.rank??1)-1],s=n.dice[0].total;if(void 0===s)return"";let r=`<div style="display:flex;justify-content:space-between;" title="${n.result}">`;return r+=`<span>${e.name} (${a})</span><span`,20==s?r+=' style="color: green;"':1==s&&(r+=' style="color: red;"'),`${r}>${n.total}</span></div>`}function J(e){"exploit-vulnerability"===e.type?g(e):"clean-exploit-vulnerability"===e.type&&y()}e||(e="idleuh"),Hooks.once("init",(()=>{(function(e){return game.modules.get(e)}(e)).api={macros:{exploitVulnerability:h,esotericCheck:r,manualToken:G,groupPerception:W,identify:E,ripImaginarium:U}}})),Hooks.once("ready",(()=>{var t;game.user.isGM&&(t=J,game.socket.on(`module.${e}`,t))}))})();
//# sourceMappingURL=main.js.map